---
title: "Diagnoses"
output: html_notebook
---

The thought here is to search for evidence of end of life care maybe before and "end of life care referral", and to do so using diagnosis codes

Diagnosis codes in CSDS can be ICD codes, Read codes or SNOMED codes. These arent necessarily compatible and certainly dont makes things easy.


```{r setup, echo = FALSE}
library(SparkR)
library(sparklyr)
library(DBI)
library(tidyverse)
library(dbplyr)
if(!require(janitor)) install.packages("janitor")
library(janitor)
library(survival)
source("aftheme_mod.R")

# if(!require(PHEindicatormethods)) install.packages("PHEindicatormethods", repos = "https://packages.sde.digital.nhs.uk/repository/cran-mirror/", dependencies = TRUE)
# library(PHEindicatormethods)
#if (!require(afcharts)) install.packages('afcharts')
#library(afcharts)
#if (!require(openxlsx)) install.packages('openxlsx')
#library(openxlsx)
#if (!require(svglite)) install.packages('svglite')
#library(svglite)

#library(afcharts)

con <- dbConnect(
odbc::odbc(),
dsn = 'databricks',
HTTPPath = 'sql/protocolv1/o/8723547585282153/1007-063142-dtxq2zhk',
PWD = rstudioapi::askForPassword('Please enter Databricks PAT'))

#############################
spellsdays <- 365
h_spc_days <- 365
period <- 90
#############################

is.integer64 <- function(x) {class(x)=="integer64"}

round_f <- function(x) {
  ifelse(
    x < 10,
    0,
    10 * round(x/10)
    )}

round_ft <- function(x) {
  y <- round_f(x)
  ifelse(
    y ==0,
    "<10",
    format(y)
  )}
```

```{sql tmp, connection = con, output.var = cht_count}
SELECT COUNT(*) AS rows
FROM dsa_484452_h8s1l.dsa_484452_h8s1l_collab.peolc_deaths_cohort
WHERE yod=2024
```

```{sql diagnosis, connection = con, output.var = diagnoses}
WITH diag AS(
  SELECT *
  FROM dsa_484452_h8s1l_collab.peolc_csds_diag
  WHERE yod = 2024)

SELECT Diagnosis, Diagnosis_Scheme, COUNT(DISTINCT Person_ID_DEID) AS people
FROM diag
GROUP BY Diagnosis, Diagnosis_Scheme

```

This is an aggregate of the number of unique codes of each type recorded among those who died


```{r tidy diagnosis, echo=FALSE}

diagnoses <- diagnoses %>%
  mutate(
    scheme2 = factor(
      Diagnosis_Scheme, 
      levels = c("02", "04", "05", "06"), 
      labels = c("ICD10", "Readv2", "ReadCTv3", "SNOMED"))) %>%
  arrange(desc(people))

diagnoses$scheme2 %>% table()

```

```{sql read3 to snomed, connection = con, output.var = read3_snomed_lu}
SELECT * FROM reference_data.dss_corporate.read_codes_map_ctv3_to_snomed
```

```{sql read2 to snomed, connection = con, output.var = read2_snomed_lu}
SELECT * FROM reference_data.dss_corporate.read_codes_map_v2_to_snomed
```

```{sql snomed_pal, connection = con, output.var = snomed_palreg_lu}
SELECT * FROM dsa_484452_h8s1l.dsa_484452_h8s1l_collab.peolc_snomed_qof_pal_reg
```

```{r to_snomed, echo=false}

diagnoses <- diagnoses %>%
  left_join(
    bind_rows(
    read3_snomed_lu %>%
      mutate(Diagnosis = CTV3_CONCEPTID, Diagnosis_Scheme = "05", snomed = SCT_CONCEPTID, .keep="none") %>%
      unique()
    ,
    read2_snomed_lu %>%
      mutate(Diagnosis = V2_READCODE, Diagnosis_Scheme = "04", snomed = SCT_CONCEPTID, .keep="none") %>%
      unique())
    ) %>%
  mutate(snomed = ifelse(Diagnosis_Scheme == "06",Diagnosis, snomed  )) 

diagnoses %>%
  arrange(desc(people))

diagnoses_nomatch <- diagnoses %>%
  filter(!Diagnosis_Scheme == "02" & is.na(snomed)  ) %>%
  arrange(desc(people))

```

```{sql snomed_codes, connection = con, output.var = snomed_codes}
SELECT *
FROM reference_data.dss_corporate.snomed_sct2_description_full

```

```{r diag_common, echo = FALSE}

diagnoses %>%
  left_join(snomed_codes %>%
              group_by(conceptId) %>%
              summarise(term = first(term))
              , by = c("snomed" = "conceptId")) %>%
  arrange(desc(people)) %>% View()

```


Some of the diagnosis codes do not appear in the Read look ups. My guess is that (at least some of them) are "Local TPP codes" see < https://biobank.ndph.ox.ac.uk/ukb/coding.cgi?id=8708&nl=1>. If thats true, then by that reference, none of the unrecognised Read codes are to do with EOL or palliative care. There 2 in the TPP list, but neither appear in this CSDS extract: 
-   Y1c4b End of life care assessment
-   Y1d79 Discussion about end of life


This is a broader list of eol snomed codes, includes dying of relative/partner

```{sql snomed_pal_spot, connection = con, output.var = snomed_pal_enq}
SELECT *,
CONCAT(
  IF(UPPER(term) LIKE '%PALLIATIVE%','1',''),
  IF(UPPER(term) LIKE '%END OF LIFE%','2',''),
  IF(UPPER(term) LIKE '%TERMINAL CARE%','3',''),
  IF(UPPER(term) LIKE '%TERMINAL ILLNESS%','4',''),
  IF(UPPER(term) LIKE '%FINAL DAYS%','5',''),
  IF(UPPER(term) LIKE '%LAST DAYS OF LIFE%','6',''),
  IF(UPPER(term) LIKE '%GOLD STANDARDS FRAMEWORK%','7',''),
  IF(UPPER(term) LIKE '%LAST WEEKS OF LIFE%','8',''),
  IF(UPPER(term) LIKE '%LAST MONTHS OF LIFE%','9',''),
  IF(UPPER(term) LIKE '% DYING%','a','')   -- needs the space to avoid dodgy matches eg "remedying" 
  ) AS which
FROM reference_data.dss_corporate.snomed_sct2_description_full
WHERE 
  UPPER(term) LIKE '%PALLIATIVE%'
  OR UPPER(term) LIKE '%END OF LIFE%'
  OR UPPER(term) LIKE '%TERMINAL CARE%'
  OR UPPER(term) LIKE '%TERMINAL ILLNESS%'
  OR UPPER(term) LIKE '%FINAL DAYS%'
  OR UPPER(term) LIKE '%LAST DAYS OF LIFE%'
  OR UPPER(term) LIKE '%GOLD STANDARDS FRAMEWORK%'
  OR UPPER(term) LIKE '%LAST WEEKS OF LIFE%'
  OR UPPER(term) LIKE '%LAST MONTHS OF LIFE%'
  OR UPPER(term) LIKE '% DYING%'
  
```

```{r diag2, echo=FALSE}
snomed_pal_enq <- snomed_pal_enq %>% 
  mutate(
    no_brackets = gsub("\\s*\\([^\\)]+\\)", "",  term),
    relative = str_detect(tolower(term), "relative|partner|child"))

snomed_pal_enq2 <- snomed_pal_enq %>% 
  select(conceptId, term, which, no_brackets, relative) %>%
  unique() %>%
  group_by(conceptId) %>%
  mutate(l = str_length(term)) %>%
  arrange(l) %>%
  slice_head() %>%
  arrange(which, term) %>%
  select(-l)

snomed_pal_combined <-
  full_join(
    snomed_pal_enq2,
    snomed_palreg_lu,
    by = c("conceptId" = "snomed_concept_id"))
    
diag_to_snomed <- diagnoses %>%
  left_join(
    bind_rows(
      read2_snomed_lu %>% 
        mutate(
          scheme2 = "Readv2",
          Diagnosis = V2_READCODE,
          snomed = SCT_CONCEPTID,
          sct_desc = SCT_DESCRIPTIONID) %>%
        select(scheme2, Diagnosis, snomed, sct_desc)
      ,
      read3_snomed_lu %>%
        mutate(
          scheme2 = "ReadCTv3",
          Diagnosis = CTV3_CONCEPTID,
          snomed = SCT_CONCEPTID,
          sct_desc = SCT_DESCRIPTIONID) %>%
        select(scheme2, Diagnosis, snomed, sct_desc)
      ,
      tibble(
        scheme2 = "ICD10",
        Diagnosis = "Z515",
        snomed = "103735009",
        sct_desc = snomed_palreg_lu$description[snomed_palreg_lu$snomed_concept_id == "103735009"][1])
      ) %>%
      unique()) %>%   
  mutate(snomed = ifelse(scheme2 == "SNOMED", Diagnosis, snomed)) 

diag_pal <- diag_to_snomed %>%
  group_by(snomed) %>%
  summarise(people=sum(people)) %>%
  left_join(snomed_pal_combined %>%
              mutate(conceptId, 
                     term = case_when(is.na(term) ~description, .default = term),
                     source_qof = !is.na(description),
                     source_wide = !is.na(term),
                     anypal = source_qof|source_wide,
                       .keep = "none" ) %>%
              unique(), 
              by = c("snomed" = "conceptId" )) %>%
    arrange(desc(anypal), term, desc(people))

```

Having converted diagnosis codes to SNOMED, if I have done this right, this is the number of people with "palliative" codes

```{r pal_list}

diag_pal %>% filter(anypal) %>% select(people, snomed, term )

```
 