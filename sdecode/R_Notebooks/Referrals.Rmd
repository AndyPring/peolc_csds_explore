```{r set up, message=FALSE, warning=FALSE, include=FALSE, cache=TRUE}

library(SparkR)
library(sparklyr)
library(DBI)
library(tidyverse)
library(dbplyr)
# if(!require(PHEindicatormethods)) install.packages("PHEindicatormethods", repos = "https://packages.sde.digital.nhs.uk/repository/cran-mirror/", dependencies = TRUE)
# library(PHEindicatormethods)
#if (!require(afcharts)) install.packages('afcharts')
#library(afcharts)
if (!require(openxlsx)) install.packages('openxlsx')
library(openxlsx)
if (!require(svglite)) install.packages('svglite')
library(svglite)

#library(afcharts)

con <- dbConnect(
  odbc::odbc(),
  dsn = 'Databricks',
  HTTPPath = 'sql/protocolv1/o/8723547585282153/1007-063142-dtxq2zhk',
  PWD = rstudioapi::askForPassword('Please enter Databricks PAT')
)

is.integer64 <- function(x) {class(x)=="integer64"}

round_f <- function(x) {
  ifelse(
    x < 10,
    0,
    10 * round(x/10)
    )}

round_ft <- function(x) {
  y <- round_f(x)
  ifelse(
    y ==0,
    "<10",
    format(y)
  )}
```

```{r get_dths, echo = FALSE, cache=TRUE}
# ```{sql, connection = con, output.var = dths_summary}

dths_summary <- tbl(con, sql("
  SELECT xage_cat, ucod_cat, COUNT(*) AS dths
  FROM dsa_484452_h8s1l.dsa_484452_h8s1l_collab.peolc_deaths_cohort AS d
  WHERE yod = 2024
  GROUP BY xage_cat, ucod_cat
  ")) %>% collect()

```

```{r dth_table, echo = FALSE, cache=TRUE}

dths_summary %>%
#  group_by(x_age_cat, ucod_cat) %>%
#  summarise( dths = SUM(dths)) %>%
  pivot_wider(
    id_cols = ucod_cat,
    names_from = xage_cat,
    values_from = dths,
    values_fn = ~sum(as.integer(.x)))
  
```

```{r get_ref, echo=FALSE, cache=TRUE}
#```{sql, connection = con, output.var = referral_summary}

referral_summary <- tbl(con, sql("WITH ref AS (
  SELECT d.DEC_CONF_NHS_NUMBER_CLEAN_DEID AS PERSON_ID_DEID,
    d.xage_cat, d.ucod_cat,
    CASE WHEN d.eol_pod = 'Hospital' THEN 'Hospital' ELSE 'xHospital' END AS pod,
    CASE 
        WHEN Pseudo_PrimaryReferralReason = '026'
            OR Pseudo_ReferralReason_Other LIKE '%026%'
            OR TeamType IN (14, 47) THEN 2    -- EOL referral
        WHEN r.PERSON_ID_DEID IS NULL THEN 0  -- No referrals
        ELSE 1                                -- referral, not EOL
        END AS ref_eol
  FROM dsa_484452_h8s1l.dsa_484452_h8s1l_collab.peolc_csds_ref AS r
  RIGHT JOIN dsa_484452_h8s1l.dsa_484452_h8s1l_collab.peolc_deaths_cohort d
  ON r.PERSON_ID_DEID = d.DEC_CONF_NHS_NUMBER_CLEAN_DEID
  WHERE d.yod = 2024)
  ,
  person AS (
  SELECT PERSON_ID_DEID, xage_cat, ucod_cat, pod, max(ref_eol) AS ref_eol
  FROM ref
  GROUP BY PERSON_ID_DEID, xage_cat, ucod_cat, pod)
  
  SELECT  
    xage_cat, ucod_cat, pod, ref_eol,
    COUNT(*) AS dths
  FROM person
  GROUP BY xage_cat, ucod_cat, pod, ref_eol
  ")) %>% collect()

```

```{r prop_with_EOLCR, echo = FALSE}

ref_pc <- left_join(
  dths_summary %>%
    mutate(dths=as.integer(dths))
  ,
  referral_summary %>%
    filter(ref_eol == 2) %>%
    group_by(xage_cat, ucod_cat) %>%
    summarise(eol_ref = sum(dths, na.rm = TRUE)) %>%
    ungroup()
  )   %>%
   {bind_rows(
     group_by(., xage_cat ) %>%
       summarise(
         dths = sum(dths, na.rm = TRUE),
         eol_ref = sum(eol_ref, na.rm = TRUE)) %>%
       ungroup() %>%
       rename(value =  xage_cat) %>%
       mutate(char = "Age") 
     ,
     group_by(., ucod_cat ) %>%
       summarise(
         dths = sum(dths, na.rm = TRUE),
         eol_ref = sum(eol_ref,na.rm = TRUE)) %>%
       ungroup() %>%
       rename(value =  ucod_cat) %>%
       mutate(char = "UCOD") %>%
       ungroup()
     )} %>%
mutate(eol_ref_pc = 100 *  eol_ref/dths )

ref_pc %>%
  select(value, char,eol_ref_pc) %>%
  mutate(eol_ref_pc = round(eol_ref_pc)) %>%
  write.csv2(file = "summary_eol_ref_pc.csv")

```



```{r earliest_referral, }
referral_summary <- tbl(con, sql("WITH ref AS (
  SELECT d.DEC_CONF_NHS_NUMBER_CLEAN_DEID AS PERSON_ID_DEID,
    d.xage_cat, d.ucod_cat,
    CASE WHEN d.eol_pod = 'Hospital' THEN 'Hospital' ELSE 'xHospital' END AS pod,
    CASE 
        WHEN Pseudo_PrimaryReferralReason = '026'
            OR Pseudo_ReferralReason_Other LIKE '%026%'
            OR TeamType IN (14, 47) THEN 2    -- EOL referral
        WHEN r.PERSON_ID_DEID IS NULL THEN 0  -- No referrals
        ELSE 1                                -- referral, not EOL
        END AS ref_eol
  FROM dsa_484452_h8s1l.dsa_484452_h8s1l_collab.peolc_csds_ref AS r
  RIGHT JOIN dsa_484452_h8s1l.dsa_484452_h8s1l_collab.peolc_deaths_cohort d
  ON r.PERSON_ID_DEID = d.DEC_CONF_NHS_NUMBER_CLEAN_DEID
  WHERE d.yod = 2024)
  ,
  person AS (
  SELECT PERSON_ID_DEID, xage_cat, ucod_cat, pod, max(ref_eol) AS ref_eol
  FROM ref
  GROUP BY PERSON_ID_DEID, xage_cat, ucod_cat, pod)
  
  SELECT  
    xage_cat, ucod_cat, pod, ref_eol,
    COUNT(*) AS dths
  FROM person
  GROUP BY xage_cat, ucod_cat, pod, ref_eol
  ")) %>% collect()



```{r clean_ref, echo = FALSE, cache=TRUE}
referral_summary <- referral_summary %>%
  mutate(across(where(is.integer64), as.integer)) %>%
  arrange(ucod_cat, xage_cat)

referral_summary 
```

```{r ref_table, echo = FALSE, cache=TRUE}

table_ref <- referral_summary %>%
  group_by(xage_cat, ucod_cat) %>%
  summarise(
    dthsall = sum(dths),
    any_ref = sum(dths[ref_eol>0]),
    eol_ref = sum(dths[ref_eol==2]),
    hospital_all = sum(dths[pod=="Hospital"]),
    hospital_any = sum(dths[pod=="Hospital" & ref_eol > 0]),
    hospital_eol = sum(dths[pod=="Hospital" & ref_eol == 2]),
    .groups = "drop")

export_table <- table_ref %>%
  filter(!xage_cat == '0-17' ) %>%
  mutate(ucod_cat = ifelse(str_detect(ucod_cat, "AIDS"), "Other", ucod_cat)) %>%
  group_by(xage_cat, ucod_cat) %>%
  summarise(across(where(is.numeric),sum), .groups="drop") %>%
  mutate(across(where(is.numeric), round_ft )) %>%
  setNames(c(
    "Age at death",
    "Underlying cause of death",
    "Total deaths",
    "With any referral",
    "With a EOL referral",
    "Total deaths in hospital",
    "Deaths in hospital, people with an referral",
    "Deaths in hospital, people with an EOL referral"))


table_ref_all <- table_ref %>%
  summarise(across(where(is.numeric), sum))


table_ref2 <- table_ref %>%
  mutate(
    ucod_cat, xage_cat, 
    dths = dthsall,
    ref_pc_any = 100 * any_ref/dthsall,
    ref_pc_eol = 100 * eol_ref/dthsall,
    pod_hospital_all = 100 * hospital_all / dthsall,
    pod_hospital_any = 100 * hospital_any / any_ref,
    pod_hospital_eol = 100 * hospital_eol / eol_ref,
    .keep = "none") %>%
  arrange(ucod_cat, xage_cat)

table_ref2_all <- table_ref %>%
  mutate(
    dths = dthsall,
    ref_pc_any = 100 * any_ref/dthsall,
    ref_pc_eol = 100 * eol_ref/dthsall,
    pod_hospital_all = 100 * hospital_all / dthsall,
    pod_hospital_any = 100 * hospital_any / any_ref,
    pod_hospital_eol = 100 * hospital_eol / eol_ref,
    .keep = "none")

ref_chart_all <- table_ref2_all %>%
  pivot_longer(
    cols = c(ref_pc_any, ref_pc_eol),
    names_prefix = "ref_pc_") %>%
  ggplot() +
    geom_col(aes(x = name, y= value, fill = name), position="dodge") +
  labs(title = "Percentage of deaths with recorded community service referrals")  +
  theme_minimal()

  ggsave("ref_all.svg", plot = ref_chart, )


ref_chart <- table_ref2 %>%
  pivot_longer(
    cols = c(ref_pc_any, ref_pc_eol),
    names_prefix = "ref_pc_") %>%
  ggplot() +
    geom_col(aes(x = xage_cat, y= value, fill = name), position="dodge") +
    geom_line(aes(x = xage_cat, y=100 * dths/(max(table_ref2$dths)), group=TRUE)) +
    scale_y_continuous(sec.axis = sec_axis(~./(100/(max(table_ref2$dths))))) +
    facet_wrap(~ucod_cat)+
  labs(title = "Percentage of deaths with recorded community service referrals")  +
  theme_minimal()

  ggsave("ref.svg", plot = ref_chart, )

dih_chart <- table_ref2 %>%
  pivot_longer(
    cols = c(pod_hospital_all, pod_hospital_any, pod_hospital_eol),
    names_prefix = "pod_hospital_") %>%
  ggplot(
    aes(x = xage_cat, y= value, fill = name), ) +
    geom_col(position="dodge") +
    facet_wrap(~ucod_cat) +
  labs(title = "Percentage of deaths in hospital") +
  theme_minimal()

  ggsave("dih.svg", dih_chart, height=7, width=12)
  
  wb <- openxlsx::createWorkbook()
  openxlsx::addWorksheet(wb, sheet = "readme")
  openxlsx::addWorksheet(wb, sheet = "data")
  
  openxlsx::writeData(wb, sheet = "readme", 
  paste0("A data table summarised for deaths data linked to CSDS referrals
  Deaths of England residents who died in 2024
  Decedants under 18 years of age excluded
  CSDS referrals only considered if during last year of life
  ", date()))
  
  openxlsx::writeData(wb, sheet = "data",export_table)
  openxlsx::saveWorkbook(wb, file="../output/referrals_death_in hospital.xlsx", overwrite = TRUE)
  
```



```{r ref_whatif, cache=TRUE}

table_ref %>%
  mutate(
    ucod_cat, xage_cat,
    dthsall, 
    dths_xeol = dthsall-eol_ref,
    dih_eol = hospital_eol/eol_ref,
    change = round(hospital_all - (dthsall * dih_eol)), 
    .keep = "none") %>%
  ggplot(aes(y=ucod_cat, x=change, fill=xage_cat)) +
  geom_col(position="stack")

```  




```{r ref_whatif, cache=TRUE}

table_ref %>%
  mutate(
    ucod_cat, xage_cat,
    dthsall, 
    dths_xeol = dthsall-eol_ref,
    dih_eol = hospital_eol/eol_ref,
    change = round(hospital_all - (dthsall * dih_eol)), 
    .keep = "none") %>%
  ggplot(aes(y=ucod_cat, x=change, fill=xage_cat)) +
  geom_col(position="stack")

```  

```{r referral_source, echo = FALSE}

referral_source <- tbl(con, sql("
SELECT DISTINCT
    PERSON_ID_DEID,
    ReferralRequest_ReceivedDate,
    dod,
    xyear,
    CASE 
        WHEN Pseudo_PrimaryReferralReason = '026'
            OR Pseudo_ReferralReason_Other LIKE '%026%'
            OR TeamType IN (14, 47) THEN 2    -- EOL referral
        WHEN r.PERSON_ID_DEID IS NULL THEN 0  -- No referrals
        ELSE 1                                -- referral, not EOL
        END AS ref_eol,
    Referring_StaffGroup
FROM dsa_484452_h8s1l.dsa_484452_h8s1l_collab.peolc_csds_ref AS r
")

```



 