{

 "cells": [

  {

   "cell_type": "code",

   "execution_count": 0,

   "metadata": {

    "application/vnd.databricks.v1+cell": {

     "cellMetadata": {

      "byteLimit": 2048000,

      "rowLimit": 10000

     },

     "inputWidgets": {},

     "nuid": "ff3ecfed-f88f-4964-ab0d-23a8eaaa532e",

     "showTitle": false,

     "tableResultSettingsMap": {

      "0": {

       "dataGridStateBlob": "{\"version\":1,\"tableState\":{\"columnPinning\":{\"left\":[\"#row_number#\"],\"right\":[]},\"columnSizing\":{},\"columnVisibility\":{}},\"settings\":{\"columns\":{}},\"syncTimestamp\":1757946713872}",

       "filterBlob": null,

       "queryPlanFiltersBlob": null,

       "tableResultIndex": 0

      }

     },

     "title": ""

    }

   },

   "outputs": [],

   "source": [

    "WITH extract AS (\n",

    "SELECT COUNT(DISTINCT Person_ID_DEID) AS people, TeamType, d.UTLA, d.dths, length(TeamType) l\n",

    "FROM hive_metastore.dsa_484452_h8s1l_collab.peolc_csds_ref r\n",

    "RIGHT JOIN (\n",

    "  SELECT UTLA, COUNT(*) AS dths \n",

    "  FROM hive_metastore.dsa_484452_h8s1l_collab.peolc_deaths_cohort\n",

    "  GROUP BY UTLA) d ON r.UTLA = d.UTLA\n",

    "WHERE yod = 2024\n",

    "GROUP BY TeamType, length(TeamType) , d.UTLA, d.dths)\n",

    ",\n",

    "england AS (\n",

    "  SELECT \n",

    "  TeamType,\n",

    "  SUM(people) AS people_Eng,\n",

    "  SUM(dths) AS dths_Eng\n",

    "  FROM extract\n",

    "  WHERE l = 2 \n",

    "  GROUP BY TeamType)\n",

    "\n",

    "  SELECT \n",

    "  e.TeamType,\n",

    "  e.people_Eng,\n",

    "  e.dths_Eng,\n",

    "  100 * people_Eng /dths_Eng AS rate_e,\n",

    "  l.UTLA,\n",

    "  l.people,\n",

    "  l.dths,\n",

    "  100 * people /dths AS rate_l,\n",

    "  (people /dths) / (people_Eng /dths_Eng) AS ratio\n",

    "  FROM england e LEFT JOIN extract l  ON e.teamtype = l.teamtype\n",

    "  WHERE l.l=2\n",

    "  ORDER BY e.teamtype \n",

    "\n",

    "\n",

    "\n",

    "\n",

    "   \n",

    "\n"

   ]

  },

  {

   "cell_type": "code",

   "execution_count": 0,

   "metadata": {

    "application/vnd.databricks.v1+cell": {

     "cellMetadata": {

      "byteLimit": 2048000,

      "rowLimit": 10000

     },

     "inputWidgets": {},

     "nuid": "703978d1-f9cf-4eb4-ae8e-8079273dc857",

     "showTitle": true,

     "tableResultSettingsMap": {

      "0": {

       "dataGridStateBlob": "{\"version\":1,\"tableState\":{\"columnPinning\":{\"left\":[\"#row_number#\"],\"right\":[]},\"columnSizing\":{},\"columnVisibility\":{}},\"settings\":{\"columns\":{}},\"syncTimestamp\":1757930051859}",

       "filterBlob": null,

       "queryPlanFiltersBlob": null,

       "tableResultIndex": 0

      }

     },

     "title": "LSOA LTLA UTLA"

    }

   },

   "outputs": [],

   "source": [

    "WITH ranked AS (\n",

    "SELECT LSOA11, OSCTY, OSLAUA, ROW_NUMBER () OVER (PARTITION BY LSOA11 ORDER BY count DESC) AS rown\n",

    "FROM \n",

    "(\n",

    "  SELECT LSOA11, OSCTY, OSLAUA, COUNT(*) AS count \n",

    "  FROM hive_metastore.dss_corporate.postcode\n",

    "  WHERE LSOA11 LIKE 'E%'\n",

    "  GROUP BY LSOA11, OSCTY, OSLAUA \n",

    "  --ORDER BY OSCTY, OSLAUA, count\n",

    ") AS q\n",

    ")\n",

    "SELECT LSOA11, OSCTY, OSLAUA, CASE WHEN OSCTY ='E99999999'THEN  OSLAUA ELSE OSCTY END AS UTLA\n",

    "FROM ranked\n",

    "WHERE rown =1"

   ]

  },

  {

   "cell_type": "code",

   "execution_count": 0,

   "metadata": {

    "application/vnd.databricks.v1+cell": {

     "cellMetadata": {

      "byteLimit": 2048000,

      "rowLimit": 10000

     },

     "inputWidgets": {},

     "nuid": "2a604c26-0208-4d9d-a3eb-417b27f712d5",

     "showTitle": false,

     "tableResultSettingsMap": {},

     "title": ""

    }

   },

   "outputs": [],

   "source": [

    "SELECT max(l.DSS_SYSTEM_UPDATED_DATE) DSS_SYSTEM_UPDATED_DATE, max(l.DSS_ONS_PUBLISHED_DATE) DSS_ONS_PUBLISHED_DATE\n",

    "FROM hive_metastore.dss_corporate.ons_lsoa_ccg_lad_v02 l"

   ]

  }

 ],

 "metadata": {

  "application/vnd.databricks.v1+notebook": {

   "computePreferences": null,

   "dashboards": [],

   "environmentMetadata": {

    "base_environment": "",

    "environment_version": "3"

   },

   "inputWidgetPreferences": null,

   "language": "sql",

   "notebookMetadata": {

    "pythonIndentUnit": 4

   },

   "notebookName": "Completeness",

   "widgets": {}

  },

  "language_info": {

   "name": "sql"

  }

 },

 "nbformat": 4,

 "nbformat_minor": 0

}

 