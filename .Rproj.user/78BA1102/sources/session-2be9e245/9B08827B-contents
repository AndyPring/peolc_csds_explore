{

 "cells": [

  {

   "cell_type": "code",

   "execution_count": 0,

   "metadata": {

    "application/vnd.databricks.v1+cell": {

     "cellMetadata": {

      "byteLimit": 2048000,

      "rowLimit": 10000

     },

     "inputWidgets": {},

     "nuid": "268d0d45-ff83-4b40-b4ef-47b6e815ebdf",

     "showTitle": false,

     "tableResultSettingsMap": {},

     "title": ""

    }

   },

   "outputs": [

    {

     "output_type": "display_data",

     "data": {

      "text/plain": [

       "Databricks visualization. Run in Databricks to view."

      ]

     },

     "metadata": {

      "application/vnd.databricks.v1.subcommand+json": {

       "baseErrorDetails": null,

       "bindings": {},

       "collapsed": false,

       "command": "%sql WITH q AS (SELECT nrows, count(*) AS CCIDs\nFROM\n(SELECT\nPseudo_Unique_CareContactID,\nCOUNT(*) nrows\nFROM hive_metastore.dsa_484452_h8s1l_collab.peolc_csds_act\nGROUP BY Pseudo_Unique_CareContactID ) AS Q\nGROUP BY nrows) SELECT `nrows`,`CCIDs` FROM q",

       "commandTitle": "Visualization 1",

       "commandType": "auto",

       "commandVersion": 0,

       "commentThread": [],

       "commentsVisible": false,

       "contentSha256Hex": null,

       "customPlotOptions": {

        "redashChart": [

         {

          "key": "type",

          "value": "CHART"

         },

         {

          "key": "options",

          "value": {

           "alignYAxesAtZero": true,

           "coefficient": 1,

           "columnConfigurationMap": {

            "x": {

             "column": "nrows",

             "id": "column_f92f80c648"

            },

            "y": [

             {

              "column": "CCIDs",

              "id": "column_f92f80c649"

             }

            ]

           },

           "dateTimeFormat": "DD/MM/YYYY HH:mm",

           "direction": {

            "type": "counterclockwise"

           },

           "error_y": {

            "type": "data",

            "visible": true

           },

           "globalSeriesType": "scatter",

           "legend": {

            "traceorder": "normal"

           },

           "missingValuesAsZero": true,

           "numberFormat": "0,0.[00000]",

           "percentFormat": "0[.]00%",

           "series": {

            "error_y": {

             "type": "data",

             "visible": true

            },

            "stacking": null

           },

           "seriesOptions": {

            "column_f92f80c649": {

             "name": "CCIDs",

             "yAxis": 0

            }

           },

           "showDataLabels": false,

           "sizemode": "diameter",

           "sortX": true,

           "sortY": true,

           "swappedAxes": false,

           "textFormat": "",

           "useAggregationsUi": true,

           "valuesOptions": {},

           "version": 2,

           "xAxis": {

            "labels": {

             "enabled": true

            },

            "type": "-"

           },

           "yAxis": [

            {

             "type": "-"

            },

            {

             "opposite": true,

             "type": "-"

            }

           ]

          }

         }

        ]

       },

       "datasetPreviewNameToCmdIdMap": {},

       "diffDeletes": [],

       "diffInserts": [],

       "displayType": "redashChart",

       "error": null,

       "errorDetails": null,

       "errorSummary": null,

       "errorTraceType": null,

       "finishTime": 0,

       "globalVars": {},

       "guid": "",

       "height": "auto",

       "hideCommandCode": false,

       "hideCommandResult": false,

       "iPythonMetadata": null,

       "inputWidgets": {},

       "isLockedInExamMode": false,

       "latestAssumeRoleInfo": null,

       "latestUser": "a user",

       "latestUserId": null,

       "listResultMetadata": null,

       "metadata": {},

       "nuid": "eb453b68-f992-41fa-8f98-ebb04268ceb1",

       "origId": 0,

       "parentHierarchy": [],

       "pivotAggregation": null,

       "pivotColumns": null,

       "position": 2.0,

       "resultDbfsErrorMessage": null,

       "resultDbfsStatus": "INLINED_IN_TREE",

       "results": null,

       "showCommandTitle": false,

       "startTime": 0,

       "state": "input",

       "streamStates": {},

       "subcommandOptions": {

        "queryPlan": {

         "selects": [

          {

           "column": "nrows",

           "type": "column"

          },

          {

           "column": "CCIDs",

           "type": "column"

          }

         ]

        }

       },

       "submitTime": 0,

       "subtype": "tableResultSubCmd.visualization",

       "tableResultIndex": 0,

       "tableResultSettingsMap": {},

       "useConsistentColors": false,

       "version": "CommandV1",

       "width": "auto",

       "workflows": null,

       "xColumns": null,

       "yColumns": null

      }

     },

     "output_type": "display_data"

    }

   ],

   "source": [

    "SET spark.sql.shuffle.partitions=auto;\n",

    "--DROP TABLE IF EXISTS hive_metastore.dsa_484452_h8s1l_collab.peolc_csds_act;\n",

    "\n",

    "-- CREATE TABLE hive_metastore.dsa_484452_h8s1l_collab.peolc_csds_act\t AS\n",

    "SELECT nrows, count(*) AS CCIDs\n",

    "FROM\n",

    "(SELECT\n",

    "Pseudo_Unique_CareContactID,\n",

    "COUNT(*) nrows\n",

    "FROM hive_metastore.dsa_484452_h8s1l_collab.peolc_csds_act\n",

    "GROUP BY Pseudo_Unique_CareContactID ) AS Q\n",

    "GROUP BY nrows\n",

    "\n",

    "\n"

   ]

  },

  {

   "cell_type": "code",

   "execution_count": 0,

   "metadata": {

    "application/vnd.databricks.v1+cell": {

     "cellMetadata": {

      "byteLimit": 2048000,

      "rowLimit": 10000

     },

     "inputWidgets": {},

     "nuid": "f817e387-a127-4a9c-bf34-e24afd1a0dfa",

     "showTitle": false,

     "tableResultSettingsMap": {

      "0": {

       "dataGridStateBlob": "{\"version\":1,\"tableState\":{\"columnPinning\":{\"left\":[\"#row_number#\"],\"right\":[]},\"columnSizing\":{\"CodedProcedure\":118},\"columnVisibility\":{}},\"settings\":{\"columns\":{}},\"syncTimestamp\":1757685842004}",

       "filterBlob": null,

       "queryPlanFiltersBlob": null,

       "tableResultIndex": 0

      }

     },

     "title": ""

    }

   },

   "outputs": [],

   "source": [

    "SELECT c.*\n",

    "FROM\n",

    "(SELECT \n",

    "  Pseudo_Unique_CareContactID,\n",

    "  COUNT(*) nrows\n",

    "FROM hive_metastore.dsa_484452_h8s1l_collab.peolc_csds_act\n",

    "GROUP BY Pseudo_Unique_CareContactID ) AS q\n",

    "INNER JOIN hive_metastore.dsa_484452_h8s1l_collab.peolc_csds_act AS c\n",

    "ON q.pseudo_unique_carecontactid = c.Pseudo_Unique_CareContactID\n",

    "WHERE nrows > 10\n",

    "ORDER BY Pseudo_Unique_CareContactID \n",

    "LIMIT 1000"

   ]

  },

  {

   "cell_type": "code",

   "execution_count": 0,

   "metadata": {

    "application/vnd.databricks.v1+cell": {

     "cellMetadata": {

      "byteLimit": 2048000,

      "rowLimit": 10000

     },

     "inputWidgets": {},

     "nuid": "b0aadccf-8c52-4f11-919d-5014fa5a997b",

     "showTitle": false,

     "tableResultSettingsMap": {},

     "title": ""

    }

   },

   "outputs": [],

   "source": [

    "SELECT c.*\n",

    "FROM\n",

    "(SELECT \n",

    "  COUNT(DISTINCT Pseudo_Unique_CareContactID) nCCID,\n",

    "  contact_date,\n",

    "  Person_ID_DEID\n",

    "FROM hive_metastore.dsa_484452_h8s1l_collab.peolc_csds_act\n",

    "GROUP BY  contact_date, Person_ID_DEID ) AS q\n",

    "INNER JOIN hive_metastore.dsa_484452_h8s1l_collab.peolc_csds_act AS c\n",

    "ON q.person_id_deid = c.Person_ID_DEID AND q.contact_date=c.Contact_Date\n",

    "WHERE nCCID > 10\n",

    "ORDER BY Person_ID_DEID, Pseudo_Unique_CareContactID, Contact_Time\n",

    "LIMIT 1000"

   ]

  }

 ],

 "metadata": {

  "application/vnd.databricks.v1+notebook": {

   "computePreferences": null,

   "dashboards": [],

   "environmentMetadata": {

    "base_environment": "",

    "environment_version": "3"

   },

   "inputWidgetPreferences": null,

   "language": "sql",

   "notebookMetadata": {

    "pythonIndentUnit": 4

   },

   "notebookName": "activity clean",

   "widgets": {}

  },

  "language_info": {

   "name": "sql"

  }

 },

 "nbformat": 4,

 "nbformat_minor": 0

}

 